#! /bin/sh
#!perl -w # --*- Perl -*--
eval 'exec perl -x $0 ${1+"$@"}'
    if 0;
#------------------------------------------------------------------------------
#$Author$
#$Date$
#$Revision$
#$URL$
#------------------------------------------------------------------------------
#*
#  Find COD numbers for the .cif files in given directories of file lists.
#**

use strict;
use COD::SOptions;
use COD::SUsage;

my %database = (
    host  => "localhost",
    user  => "reader",
    name  => "oqmd",
    tables => {
        structures => "structures",
    },
    password => "",
    platform => "mysql",
    dbh => undef,
);

my %options;
my $limit;

#*Usage:
#*     $0 [options] [structure1_id  ...]
#*
#*Options:
#*     -L, --limit 10, --limit 1000,10
#*        Add the limit clause to the structure query statement
#*        (default: all structures are output from teh database)
#*
#*     -L-, --no-limit
#*        Remove any previously set query limits.
#*
#*     -d, --database  cod
#*        Use database "cod" to query for strctures.
#*
#*     -h, --host   www.crystallography.net
#*     -s, --server www.crystallography.net
#*        Query COD database on the host 'www.crystallography.net'.
#*
#*     -l, --localhost
#*        Use database server on the localhost to query the COD database.
#*
#*     -p, --port 3306
#*        Use use the specified port (default 3306) to query structures.
#*
#*     -t, --table  data
#*        Use SQL table "data" to query for strctures.
#*
#*     -u, --user cod_reader
#*        Use user name "cod_reader" to access COD database; this reader
#*        sould be granted SELECT priviledge, i.e. should be able to read
#*        the COD database, whithout supplying a password.
#*
#*     --password
#*        Use the specified password (default empty) to connect.
#*
#*     --help  print a short usage message (this message) and exit.
#**

@ARGV = getOptions( 
    "-d,--database"  => \$database{name},
    "-l,--localhost" => sub { $database{host} = 'localhost' },
    "-h,--host"      => \$database{host},
    "-p,--port"      => \$database{port},
    "-s,--server"    => \$database{host},
    "-t,--table"     => \$database{table},
    "-u,--user"      => \$database{user},
    "--password"     => \$database{password},
    "--platform"     => \$database{platform},

    "-L,--limit"     => \$limit,
    "-L-,--no-limit" => sub { $limit = undef },

    "--help,--usage" => sub { usage; exit },
);

my $connected_db = database_connect( \%database );

my @structure_ids = @ARGV;

if( !@structure_ids ) {
    @structure_ids = query_OQMD_structure_ids( $connected_db, $limit );
}

for my $structure_id (@structure_ids) {
    print "data_", $structure_id, "\n";
}

database_disconnect( $connected_db );

#------------------------------------------------------------------------------

sub database_connect
{
    my ( $database ) = @_;
    
    my $dbh = DBI->connect( "dbi:$database->{platform}:" .
                            "hostname=$database->{host};".
                            "dbname=$database->{name};".
                            "user=$database->{user};".
                            "password=$database->{password}" )
        || die "cannot connect do the database -- $DBI::errstr";

    my %connected_db = %{$database};

    $connected_db{dbh} = $dbh;

    return wantarray ? %connected_db : \%connected_db;
}

sub database_disconnect
{
    my ( $database ) = @_;

    $database->{dbh}->disconnect || die "cannot disconnect -- $DBI::errstr";

    $database->{dbh} = undef;
}

sub query_OQMD_structure_ids
{
    my ( $database, $limit ) = @_;

    my $dbh = $database->{dbh};

    use DBI;

    my $sth = $dbh->prepare(
        "SELECT id FROM `$database->{tables}{structures}` ORDER BY id" .
        (defined $limit ? " LIMIT " . $limit : "") . ";"
        );

    $sth->execute();

    my @ids = map { $_->[0] } @{$sth->fetchall_arrayref()};

    return @ids;
}
