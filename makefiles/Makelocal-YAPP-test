#---*- Makefile -*-------------------------------------------------------------
#$Author$
#$Date$
#$Revision$
#$URL$
#------------------------------------------------------------------------------

PERL5LIB := ../lib/perl5:${PERL5LIB}
export PERL5LIB

# Variables used to make module in the local package lib layout
PKG_TOP   = lib

CWD = ${notdir $(shell pwd)}
TEST_MODULE = ${CWD}.pm

WORK_TESTS = ${wildcard *.inp}
TEST_DIR = tests
INP_DIR  = ${TEST_DIR}/inputs
OUTP_DIR = ${TEST_DIR}/outputs

TEST_FILES = ${wildcard ${INP_DIR}/*.inp}
DIFF_FILES = ${TEST_FILES:${INP_DIR}/%.inp=${OUTP_DIR}/%.diff}
OUTP_FILES = ${TEST_FILES:${INP_DIR}/%.inp=${OUTP_DIR}/%.out}

TEST_DRIVER = ${TEST_DIR}/scripts/test-driver

.PHONY: all clean cleanAll distclean test tests alltests out outputs
.PHONY: run times

all: run tests

SHELL = /bin/bash

run: ${PKG_TOP}/${PKG_PATH}/${TEST_MODULE} ${WORK_TESTS}
	@for file in ${WORK_TESTS}; do \
	( \
		echo === $$file ===; \
		set -x; \
		${TEST_DRIVER} < $$file \
	); \
	done

times: ${PKG_TOP}/${PKG_PATH}/${TEST_MODULE} ${WORK_TESTS}
	for file in ${WORK_TESTS}; do \
	( \
		echo === $$file ===; \
		set -x; \
		time ${TEST_DRIVER} < $$file \
	); \
	done

tests alltests: test shtest

#------------------------------------------------------------------------------

test: ${DIFF_FILES}

out outputs: ${OUTP_FILES}

${OUTP_DIR}/%.diff: ${PKG_TOP}/${PKG_PATH}/${TEST_MODULE} ${INP_DIR}/%.inp ${INP_DIR}/%.opt
	-@printf "%-30s " "$*:" ; \
	${TEST_DRIVER} < ${word 2, $^} 2>&1 \
        $(shell grep -v '^#' ${word 3, $^}) \
        | diff ${OUTP_DIR}/$*.out - \
        > $@ ; \
	if [ $$? = 0 ]; then echo "OK"; else echo "FAILED:"; cat $@; fi

${OUTP_DIR}/%.diff: ${PKG_TOP}/${PKG_PATH}/${TEST_MODULE} ${INP_DIR}/%.inp
	-@printf "%-30s " "$*:" ; \
	${TEST_DRIVER} < ${word 2, $^} 2>&1 \
        | diff ${OUTP_DIR}/$*.out - \
        > $@ ; \
	if [ $$? = 0 ]; then echo "OK"; else echo "FAILED:"; cat $@; fi

${OUTP_DIR}/%.out: ${PKG_TOP}/${PKG_PATH}/${TEST_MODULE} ${INP_DIR}/%.inp ${INP_DIR}/%.opt
	-@test -f $@ || echo "$@:"
	-@test -f $@ || \
	${TEST_DRIVER} < ${word 2, $^} 2>&1 \
        $(shell grep -v '^#' ${word 3, $^}) \
	| tee $@
	-@touch $@

${OUTP_DIR}/%.out: ${PKG_TOP}/${PKG_PATH}/${TEST_MODULE} ${INP_DIR}/%.inp
	-@test -f $@ || echo "$@:"
	-@test -f $@ || \
	${TEST_DRIVER} < ${word 2, $^} 2>&1 \
	| tee $@
	-@touch $@

#------------------------------------------------------------------------------

.PHONY: shtests

#
# Outputs and tests for the shell-driven tests:
#

SHELL_TSTDIR = ./${TEST_DIR}/shtests
SHELL_OUTDIR = ./${TEST_DIR}/shoutputs

SHELL_TESTS   = ${wildcard ${SHELL_TSTDIR}/*.sh}
SHELL_BASES   = ${notdir ${SHELL_TESTS}}
SHELL_OUTPUTS = ${addprefix ${SHELL_OUTDIR}/, ${SHELL_BASES:%.sh=%.out}}
SHELL_DIFFS   = ${addprefix ${SHELL_OUTDIR}/, ${SHELL_BASES:%.sh=%.diff}}

shoutputs shout: ${SHELL_OUTPUTS}

shtest shtests: ${SHELL_DIFFS}

${SHELL_OUTDIR}/%.out: ${SHELL_TSTDIR}/%.sh ${PKG_TOP}/${PKG_PATH}/${TEST_MODULE}
	-@test -f $@ || echo "$@:"
	-@test -f $@ || $< ./${TEST_MODULE} 2>&1 | tee $@
	-@touch $@

${SHELL_OUTDIR}/%.diff: ${SHELL_TSTDIR}/%.sh ${PKG_TOP}/${PKG_PATH}/${TEST_MODULE}
	-@printf "%-30s " "$*:" ; \
	$< ./${TEST_MODULE} 2>&1 | diff ${SHELL_OUTDIR}/$*.out - > $@ ; \
	if [ $$? = 0 ]; then echo "OK"; else echo "FAILED:"; cat $@; fi

#------------------------------------------------------------------------------

.PHONY: listdiff

listdiff: # test
	@-( test -d ${OUTP_DIR} && \
	    ls -l ${OUTP_DIR}/*.diff | awk '{if( $$5 > 0 ) print}' ) || \
	    true
	@-( test -d ${SHELL_OUTDIR} && \
	    ls -l ${SHELL_OUTDIR}/*.diff | awk '{if( $$5 > 0 ) print}' ) || \
	    true

#------------------------------------------------------------------------------

clean-YAPP-test:
	rm -f ${DIFF_FILES}
	rm -f ${SHELL_DIFFS}

clean: clean-YAPP-test
