
MAKECONF_FILES = ${filter-out %~, ${wildcard Makeconf*}}

ifneq ("${MAKECONF_FILES}","")
include ${MAKECONF_FILES}
endif

PERL5LIB := ../lib/perl5:${PERL5LIB}
export PERL5LIB

YP_FILES  = ${wildcard *.yp}
PM_FILES  = ${YP_FILES:%.yp=%.pm}
# Variables used to make module in the local package lib layout
PKG_TOP   = lib
PKG_FILES = ${PM_FILES:%.pm=${PKG_TOP}/${PKG_PATH}/%.pm}
# Variables used to move perl modules to the proper directory in COD layout
LIB_FILES = ${PM_FILES:%.pm=${LIB_DIR}/%.pm}

TEST_MODULE = ${firstword ${PM_FILES}}
WORK_TESTS = ${wildcard *.inp}
TEST_DIR = tests
OUTP_DIR = outputs

TEST_FILES = ${wildcard ${TEST_DIR}/*.inp}
DIFF_FILES = ${TEST_FILES:${TEST_DIR}/%.inp=${OUTP_DIR}/%.diff}
OUTP_FILES = ${TEST_FILES:${TEST_DIR}/%.inp=${OUTP_DIR}/%.out}

.PRECIOUS: %.pm ${LIB_FILES}
.PHONY: all clean cleanAll distclean test tests alltests out outputs
.PHONY: run times

## all: ${PM_FILES}
all: run tests ${LIB_FILES}

SHELL = /bin/bash

${LIB_FILES}: ${PKG_FILES}
	cp -f $< $@

run: ${PKG_FILES} ${WORK_TESTS}
	@for file in ${WORK_TESTS}; do \
	( \
		echo === $$file ===; \
		set -x; \
		perl -e 'use ${PKG_PREFIX}${TEST_MODULE:%.pm=%};' \
			 -e 'my $$parser = new ${PKG_PREFIX}${TEST_MODULE:%.pm=%};' \
			 -e '$$parser->Run' < $$file \
	); \
	done

times: ${PKG_FILES} ${WORK_TESTS}
	for file in ${WORK_TESTS}; do \
	( \
		echo === $$file ===; \
		set -x; \
		time perl -e 'use ${PKG_PREFIX}${TEST_MODULE:%.pm=%};' \
				  -e 'my $$parser = new ${PKG_PREFIX}${TEST_MODULE:%.pm=%};' \
				  -e '$$parser->Run' < $$file \
	); \
	done

tests alltests: test shtest

#------------------------------------------------------------------------------

test: ${DIFF_FILES}

out outputs: ${OUTP_FILES}

${PKG_TOP}/${PKG_PATH}/%.pm: %.yp
	yapp -v -m ${PKG_PREFIX}$* -o $@ $<

${OUTP_DIR}/%.diff: ${PKG_TOP}/${PKG_PATH}/${TEST_MODULE} ${TEST_DIR}/%.inp ${TEST_DIR}/%.opt
	-@printf "%-30s " "$*:" ; \
	perl -e 'use ${PKG_PREFIX}${TEST_MODULE:%.pm=%};' \
		 -e 'my $$p=new ${PKG_PREFIX}${TEST_MODULE:%.pm=%};' \
		 -e '$$p->Run( undef, { map { $$_ => 1 } @ARGV } )' \
         < ${word 2, $^} 2>&1 \
         $(shell grep -v '^#' ${word 3, $^}) \
     | diff ${OUTP_DIR}/$*.out - \
     > $@ ; \
	if [ $$? = 0 ]; then echo "OK"; else echo "FAILED:"; cat $@; fi

${OUTP_DIR}/%.diff: ${PKG_TOP}/${PKG_PATH}/${TEST_MODULE} ${TEST_DIR}/%.inp
	-@printf "%-30s " "$*:" ; \
	perl -e 'use ${PKG_PREFIX}${TEST_MODULE:%.pm=%};' \
		 -e 'my $$p=new ${PKG_PREFIX}${TEST_MODULE:%.pm=%};' \
		 -e '$$p->Run( undef, { map { $$_ => 1 } @ARGV } )' \
         < ${word 2, $^} 2>&1 \
     | diff ${OUTP_DIR}/$*.out - \
     > $@ ; \
	if [ $$? = 0 ]; then echo "OK"; else echo "FAILED:"; cat $@; fi

${OUTP_DIR}/%.out: ${PKG_TOP}/${PKG_PATH}/${TEST_MODULE} ${TEST_DIR}/%.inp ${TEST_DIR}/%.opt
	-@test -f $@ || echo "$@:"
	-@test -f $@ || \
	perl -e 'use ${PKG_PREFIX}${TEST_MODULE:%.pm=%};' \
		 -e 'my $$p=new ${PKG_PREFIX}${TEST_MODULE:%.pm=%};' \
		 -e '$$p->Run( undef, { map { $$_ => 1 } @ARGV } )' \
		 < ${word 2, $^} 2>&1 \
         $(shell grep -v '^#' ${word 3, $^}) \
	| tee $@
	-@touch $@

${OUTP_DIR}/%.out: ${PKG_TOP}/${PKG_PATH}/${TEST_MODULE} ${TEST_DIR}/%.inp
	-@test -f $@ || echo "$@:"
	-@test -f $@ || \
	perl -e 'use ${PKG_PREFIX}${TEST_MODULE:%.pm=%};' \
		 -e 'my $$p=new ${PKG_PREFIX}${TEST_MODULE:%.pm=%};' \
		 -e '$$p->Run( undef, { map { $$_ => 1 } @ARGV } )' \
		 < ${word 2, $^} 2>&1 \
	| tee $@
	-@touch $@

#------------------------------------------------------------------------------

.PHONY: shtests

#
# Outputs and tests for the shell-driven tests:
#

SHELL_TSTDIR = ./shtests
SHELL_OUTDIR = ./shoutputs

SHELL_TESTS   = ${wildcard ${SHELL_TSTDIR}/*.sh}
SHELL_BASES   = ${notdir ${SHELL_TESTS}}
SHELL_OUTPUTS = ${addprefix ${SHELL_OUTDIR}/, ${SHELL_BASES:%.sh=%.out}}
SHELL_DIFFS   = ${addprefix ${SHELL_OUTDIR}/, ${SHELL_BASES:%.sh=%.diff}}

shoutputs shout: ${SHELL_OUTPUTS}

shtest shtests: ${SHELL_DIFFS}

${SHELL_OUTDIR}/%.out: ${SHELL_TSTDIR}/%.sh ${PKG_TOP}/${PKG_PATH}/${TEST_MODULE}
	-@test -f $@ || echo "$@:"
	-@test -f $@ || $< ./${TEST_MODULE} 2>&1 | tee $@
	-@touch $@

${SHELL_OUTDIR}/%.diff: ${SHELL_TSTDIR}/%.sh ${PKG_TOP}/${PKG_PATH}/${TEST_MODULE}
	-@printf "%-30s " "$*:" ; \
	$< ./${TEST_MODULE} 2>&1 | diff ${SHELL_OUTDIR}/$*.out - > $@ ; \
	if [ $$? = 0 ]; then echo "OK"; else echo "FAILED:"; cat $@; fi

#------------------------------------------------------------------------------

.PHONY: listdiff

listdiff: # test
	@-( test -d ${OUTP_DIR} && \
	    ls -l ${OUTP_DIR}/*.diff | awk '{if( $$5 > 0 ) print}' ) || \
	    true
	@-( test -d ${SHELL_OUTDIR} && \
	    ls -l ${SHELL_OUTDIR}/*.diff | awk '{if( $$5 > 0 ) print}' ) || \
	    true

#------------------------------------------------------------------------------

clean:
	rm -f ${DIFF_FILES}
	rm -f ${SHELL_DIFFS}

distclean cleanAll: clean
	rm -f ${PKG_FILES} ${LIB_FILES}
