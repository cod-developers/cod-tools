#--*- Makefile -*--------------------------------------------------------------
#$Author$
#$Revision$
#$Date$
#$URL$
#------------------------------------------------------------------------------

CODTOOLS    = cod-tools
LIBCOD_PERL = libcod-cif-parser-bison-perl
LIBCODCIF   = libcodcif
PYCODCIF    = pycodcif

AUTHOR_NAME  = Saulius GraÅ¾ulis
AUTHOR_EMAIL = grazulis@ibt.lt
REVISION  = $(shell svnversion)
DATE      = $(shell date --rfc-2822)

PREFIX = ${DEBIAN}/${PKGNAME}

DEBIAN    = debian
CHANGELOG = ${DEBIAN}/changelog
CONTROL   = ${DEBIAN}/control
COPYRIGHT = ${DEBIAN}/copyright

LIBCODCIF_A_DEST  = ${DEBIAN}/${LIBCODCIF}/usr/lib
LIBCODCIF_INC_DEST = ${DEBIAN}/${LIBCODCIF}/usr/include

# Taking the dependencies from {build,run}.sh:

BUILD_DEPS_LIST = dependencies/Ubuntu-12.04/build.sh
RUN_DEPS_LIST   = dependencies/Ubuntu-12.04/run.sh

BUILD_DEPS = $(shell grep install ${BUILD_DEPS_LIST} \
                 | awk '{print $$NF}' \
                 | xargs perl -e 'print join ", ", ( "debhelper (>=9)", @ARGV )')
RUN_DEPS = $(shell grep install ${RUN_DEPS_LIST} \
                 | awk '{print $$NF}' \
                 | xargs perl -e 'print join ", ", @ARGV')

# Collecting Perl binaries and libraries:

CODTOOLS_LIBS = $(shell find src/lib/perl5 -name .svn -prune -o \
                                           -name Bison -prune -o \
                                           -name Bison.pm -prune -o \
                                           -name Yapp -prune -o \
                                           -name Precision.pm -prune -o \
                                           -name UserMessage.pm -prune -o \
                                           -name \*.pm -print)

LIBCOD_PERL_LIBS = src/lib/perl5/auto/COD/CIF/Parser/Bison/Bison.so \
                   src/lib/perl5/COD/CIF/Parser/Bison.pm \
                   src/lib/perl5/COD/Precision.pm \
                   src/lib/perl5/COD/UserMessage.pm

PYCODCIF_LIBS = $(shell find src/lib/python2.7 -name .svn -prune -o \
                                               -name \*.py -print -o \
                                               -name \*.so -print)

LIBCODCIF_A = src/components/codcif/lib/libcodcif.a
LIBCODCIF_H = ${wildcard src/components/codcif/*.h}

CEXCEPTIONS_A = src/externals/cexceptions/lib/libcexceptions.a
CEXCEPTIONS_H = ${wildcard src/externals/cexceptions/*.h}

GETOPTIONS_A = src/externals/getoptions/lib/libgetoptions.a
GETOPTIONS_H = ${wildcard src/externals/getoptions/*.h}

define newline


endef

define changelog_body
${CODTOOLS} (${REVISION}-1) UNRELEASED; urgency=low

  * Initial release.

 -- ${AUTHOR_NAME} <${AUTHOR_EMAIL}>  ${DATE}
endef

define control_body
Source: ${PKGNAME}
Maintainer: ${AUTHOR_NAME} <${AUTHOR_EMAIL}>
Section: misc
Priority: optional
Standards-Version: 3.9.3
Build-Depends: ${BUILD_DEPS}

Package: ${PKGNAME}
Architecture: any
Depends: ${RUN_DEPS}, $${perl:Depends}, $${shlibs:Depends}
Description: tools for Crystallography Open Database
 CIF management tools
endef

${CHANGELOG}:
	echo '$(subst $(newline),\n,${changelog_body})' > $@

${CONTROL}:
	echo '$(subst $(newline),\n,${control_body})' > $@

build:
	$(MAKE) -C src/

deb: ${CHANGELOG} ${CONTROL} ${COPYRIGHT}
	fakeroot debian/rules binary

install: build install-codtools install-libcod-perl install-libcodcif install-pycodcif

install-codtools:
	test -d ${DEBIAN}/${CODTOOLS}/usr/bin || mkdir -p ${DEBIAN}/${CODTOOLS}/usr/bin
	install ${CODTOOLS_SCRIPTS} ${DEBIAN}/${CODTOOLS}/usr/bin
	for i in ${CODTOOLS_LIBS:src/%=%}; \
	do \
		test -d ${DEBIAN}/${CODTOOLS}/usr/$$(dirname $$i) \
			|| mkdir -p ${DEBIAN}/${CODTOOLS}/usr/$$(dirname $$i); \
		install --mode 644 src/$$i ${DEBIAN}/${CODTOOLS}/usr/$$i; \
	done

install-libcod-perl:
	for i in ${LIBCOD_PERL_LIBS:src/%=%}; \
	do \
	test -d ${DEBIAN}/${LIBCOD_PERL}/usr/$$(dirname $$i) \
			|| mkdir -p ${DEBIAN}/${LIBCOD_PERL}/usr/$$(dirname $$i); \
		install --mode 644 src/$$i ${DEBIAN}/${LIBCOD_PERL}/usr/$$i; \
	done

install-pycodcif:
	test -d ${DEBIAN}/${PYCODCIF}/usr/bin || mkdir -p ${DEBIAN}/${PYCODCIF}/usr/bin
	install scripts/cif_printout_Python ${DEBIAN}/${PYCODCIF}/usr/bin
	for i in ${PYCODCIF_LIBS:src/%=%}; \
	do \
	test -d ${DEBIAN}/${PYCODCIF}/usr/$$(dirname $$i) \
			|| mkdir -p ${DEBIAN}/${PYCODCIF}/usr/$$(dirname $$i); \
		install --mode 644 src/$$i ${DEBIAN}/${PYCODCIF}/usr/$$i; \
	done

install-libcodcif:
	test -d ${LIBCODCIF_A_DEST} || mkdir -p ${LIBCODCIF_A_DEST}
	test -d ${LIBCODCIF_INC_DEST} || mkdir -p ${LIBCODCIF_INC_DEST}
	install --mode 644 ${LIBCODCIF_A} ${CEXCEPTIONS_A} ${GETOPTIONS_A} ${LIBCODCIF_A_DEST}
	install --mode 644 ${LIBCODCIF_H} ${CEXCEPTIONS_H} ${GETOPTIONS_H} ${LIBCODCIF_INC_DEST}

clean-deb:
	debian/rules clean

testinstall:
	$(MAKE) tests TEST_INSTALL=1
