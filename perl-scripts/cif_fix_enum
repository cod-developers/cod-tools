#! /bin/sh
#!perl -w # --*- Perl -*--
eval 'exec perl -x $0 ${1+"$@"}'
    if 0;

#------------------------------------------------------------------------------
#$Author: adriana $
#$Date: 2010-05-30 08:18:18 +0300 (Sun, 30 May 2010) $
#$Revision: 1280 $
#$URL: svn://vartai.ibt.lt/cif-tools/trunk/perl-scripts/cif_fix_enum $
#------------------------------------------------------------------------------
#*
#  Fixes enumeration values in CIF file against CIF dictionaries.
#**

use strict;
use warnings;
use lib "./lib/perl5";
use lib "./CIFParser";
use CIFDictTags;
use CIFCODTags;
use CIFParser;
use CIFTagCanonicalNames;
use ShowStruct;
use SOptions;
use CIFTagPrint;
use CIFTagManage;
use SUsage;

my $dictParsed = [];
my $parser = new CIFParser;
my $dictFile;
my @dictionaries = [];
my %dictTags;
my %tagDicts;

my $Id = '$Id: cif_fix_values 1391 2010-09-07 12:51:13Z saulius $';
my $keep_tag_order = 0;

#*Usage:
#*      cif_fix_enum [options] COD-cif-dir/
#*
#*Options:
#*     --dictionary cif_core.dic
#*        Any valid CIF file, with CIF dictionary (according to DDL2).
#*        You can define any number of CIF dictionaries, in a way like 
#*        this:
#*        $0 --dictionary cif_core.dic --dictionary cod_core.dic
#*     --add-dictionary cif_core.dic
#*        You can add CIF dictionary, in a way like 
#*        this:
#*        $0 --add-dictionary cif_core.dic
#*     --clear-dictionaries
#*		  You can clear all dictionaries used for checking
#*		  CIF file, in a way like this:
#*		  $0 --clear-dictionary
#*
#**

@ARGV = getOptions(
        "--keep-tag-order" 
            => sub { $keep_tag_order = 1; },
        "--sort-tags"      
            => sub { $keep_tag_order = 0; },
        "-d,--dictionary"
            => \$dictFile,
        "-D,--add-dictionaries"
            => \@dictionaries,
        "--clear-dictionaries"
            => sub{ @dictionaries = () },
);

for my $dict_name ( $dictFile ) {
    my $parser = new CIFParser;
    my $data = $parser->Run( $dict_name );
    	
	canonicalize_all_names( $data );
    for my $dataset ( @$data ) {
		my $values = $dataset->{values};
		my $values_name = $values->{_name};
		my $values_enum = $values->{_enumeration};
		if( (defined $values_name) && (defined $values_enum) ) {
			my @enums = @$values_enum;
			my @tag_names = @$values_name;;
			foreach( @tag_names ) {
				$dictTags{$_} = \@enums;
    			$tagDicts{$_} = $dict_name;
			}
		}
	}
	# FOR CHECK: 
	#    Prints in STDOUT enumeration value's tag and
	#	 dictionary name, where it was found.
	#
	# foreach( keys %tagDicts ) {
    #     print "$_:\n";
	#     foreach( $tagDicts{$_} ) {
	#	      print "    $_\n";
	#     }
	# }
	#
	# FOR CHECK:
	#     Prints in STDOUT CIF tags parsed from specified dictionary
	#     with appropriates (all possible) values.
	#
	# foreach(sort keys %dictTags) {
	#     print "$_:\n";
	#	  foreach( sort @{ $dictTags{$_} } ) {
	#		 print "    $_\n";
	#	 }
	# }
	
	if( defined $parser->YYData->{ERRCOUNT} &&
        $parser->YYData->{ERRCOUNT} > 0 ) {
		print STDERR "$0: $dict_name: ",
		$parser->YYData->{ERRCOUNT},
		" error(s) encountered while parsing CIF dictionary\n";
		## exit -1;
		next;
	}
}

@ARGV = ("-") unless @ARGV;
for my $filename ( @ARGV ) {
    my $parser = new CIFParser;
    my $data = $parser->Run( $filename );
    
    if( defined $parser->YYData->{ERRCOUNT} &&
        $parser->YYData->{ERRCOUNT} > 0 ) {
		print STDERR "$0: $filename: ",
		$parser->YYData->{ERRCOUNT},
		" error(s) encountered while parsing CIF file\n";
		## exit -1;
		next;
	}
	
	#canonicalize_all_names( $data );
    #for my $dataset (@$data) {
		#my $values = $dataset->{values};
		
	#}
}





