#! /bin/sh
#!perl -w # --*- Perl -*--
eval 'exec perl -x $0 ${1+"$@"}'
    if 0;
#------------------------------------------------------------------------------
#$Author$
#$Date$
#$Revision$
#$URL$
#------------------------------------------------------------------------------
#*
#  Parse a pdCIF file and check the relations between chemical species
#  and diffraction data blocks.
#**

use strict;
use lib "./lib/perl5";
use lib "./CIFParser";
use lib "./CCIFParser";
use lib ".";
use CIFParser;
use CCIFParser;
use CODPredepositionCheck;
use SOptions;
use UserMessage;

my $use_parser = "perl";
my $overall_info_datablock_name;
my $print_groups = 0;

@ARGV = getOptions(
    "--overall-information-datablock"   => \$overall_info_datablock_name,

    "--print-groups"      => sub{ $print_groups = 1 },
    "--dont-print-groups" => sub{ $print_groups = 0 },
    "--no-print-groups"   => sub{ $print_groups = 0 },

    "--use-perl-parser"       => sub{ $use_parser = "perl" },
    "--use-c-parser"          => sub{ $use_parser = "c" }
);

foreach my $filename ( @ARGV ) {

    my( $data, $error_count );
    my %options;

    if( $use_parser eq "perl" ) {
        my $parser = new CIFParser;

        $data = $parser->Run($filename, \%options);

        if( defined $parser->YYData->{ERRCOUNT} ) {
            $error_count = $parser->YYData->{ERRCOUNT};
        }
    } else {
        ( $data, $error_count ) = CCIFParser::parse( $filename, \%options );
    }

    if( defined $error_count && $error_count > 0 ) {
        print STDERR "$0: ", $error_count,
            " error(s) encountered while parsing file '${filename}'\n";
        next INPUTFILE;
    }

    my $options = { print_groups => $print_groups };
    if( defined $overall_info_datablock_name ) {
        $options->{overall_info_datablock_name} =
            $overall_info_datablock_name;
    }

    my $result = CODPredepositionCheck::check_pdcif_relations( $data,
                                                               $filename,
                                                               $options );
}
