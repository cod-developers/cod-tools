#! /bin/sh
#------------------------------------------------------------------------------
#$Author$
#$Date$ 
#$Revision$
#$URL$
#------------------------------------------------------------------------------
#*
#   Deposit CIFs into COD database using CGI deposition interface.
#
#   Usage: $0 structure1.cif [structure2.cif ...]
#**

TMP_DIR="${TMPDIR}"

set -ue
## set -x

script() { echo "$*"; }
setvar() { eval $1="'$3'"; }

setvar Id = '$Id$'

setvar INPUT_CONFIG = "${HOME}/.cod_deposit.cfg"
setvar SERVER       = "http://test.crystallography.net"
setvar DEPOSIT_PATH = "cod/cgi-bin/cif-deposit.pl"
setvar DEPOSIT_URL  = "${SERVER}/${DEPOSIT_PATH}"

setvar FILES = ""

setvar BASENAME = "`basename $0`"

# Executables:

curl=curl

#** OPTIONS:
#**  -c, --config config-file-with-password.cfg
#**      Specify which file holds depostor user name and
#**      password (default: ~/.cod_deposit.cfg
#**
#**  --help                   print short help message (this message) and exit
while [ $# -gt 0 ]
do
  case $1 in
      -c|--config|--confi|--conf|--con|--co|--co)
          INPUT_CONFIG="$2"
          shift
          ;;
      -h|--host|--hos|--ho|--h)
          SERVER="http://$2"
          DEPOSIT_URL="${SERVER}/${DEPOSIT_PATH}"
          shift
          ;;
      -p|--path)
          DEPOSIT_PATH="$2"
          DEPOSIT_URL="${SERVER}/${DEPOSIT_PATH}"
          shift
          ;;
      -u|--url|--ur|--u)
          DEPOSIT_URL="$2"
          shift
          ;;
      --script|--scrip|--scri|--scr|--sc|--s)
          curl="script curl"
          ;;
      --run|--ru|--r)
          curl=curl
          ;;
      --help|--hel|--he|--h)
            awk '/#\*/,/#\*\*/ {
                    sub("^ *#[*]?[*]?", ""); \
                    gsub("\\$0","'$0'"); \
                    print $0
                }' $0
	    exit
	    ;;      
      -*) echo "`basename $0`: unknown option $1" >&2 ; exit 1 ;;
      *)  FILES="$FILES '$1'" ;;
    esac
    shift
done

## echo ${FILES}
eval set -- "${FILES}"

test -z "${TMP_DIR}" && TMP_DIR="/tmp"
TMP_DIR="${TMP_DIR}/tmp-${BASENAME}-$$"
mkdir "${TMP_DIR}"

TMP_CIFFILE="${TMP_DIR}/$(basename $0 .sh).cif"
TMP_PASSWRD="${TMP_DIR}/password"

touch ${TMP_PASSWRD}
chmod 600 ${TMP_PASSWRD}

USERNAME=$(awk -F= '/^username=/{print $2}' ${INPUT_CONFIG})
awk -F= '/^password=/{print $2}' ${INPUT_CONFIG} | tr -d "\n" > ${TMP_PASSWRD}

cat ${1+"$@"} > ${TMP_CIFFILE}

${curl} \
    -F "username=${USERNAME}" \
    -F "password=<${TMP_PASSWRD}" \
    -F "cif=@${TMP_CIFFILE};filename=$(basename ${TMP_CIFFILE})" \
    -F "deposition_type=published" \
    ${DEPOSIT_URL} \

rm -rf "${TMP_DIR}"
